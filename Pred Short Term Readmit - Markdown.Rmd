---
title: "Predicting Short Term Readmission Among Diabetes Patients"
output: pdf_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls(all = TRUE))
#install.packages("bestglm")
#install.packages("pROC")
#install.packages("leaps")
#install.packages("car")
library(xtable)
library(bestglm)
library(pROC)
library(plyr)
library(dplyr)
library(ggplot2)
library(leaps)
library(glmnet)
library(car)
library(stargazer)
readmission_data <- read.csv("~/readmission.csv") #clean data
```


```{r include=FALSE}
str(readmission_data) #all categorical variables are correctly identified as factors
summary(readmission_data)
table(readmission_data$diag1_mod)
sum(is.na(readmission_data)) #no NAs
names(readmission_data)
table(readmission_data$diag1_mod)
table(readmission_data$readmitted)
table(as.numeric(readmission_data$readmitted)) #getting real values for categories
readmission_data$recode_readmitted <- c()
readmission_data$recode_readmitted <- readmission_data$readmitted #creating duplicate readmitted variable
table(readmission_data$recode_readmitted)
levels(readmission_data$recode_readmitted) <- c(1,0,0) #recoding readmitted (1 = readmitted < 30 days; 0 = not readmitted < 30 days)
table(readmission_data$recode_readmitted)

summary(readmission_data$recode_readmitted)
names(readmission_data)

unique(readmission_data$patient_nbr)

ifelse(duplicated(readmission_data$patient_nbr, incomparables = FALSE),1,0)

duplicated(readmission_data$patient_nbr, incomparables = FALSE) #identifying the duplicate values
sum(duplicated(readmission_data$patient_nbr, incomparables = FALSE)) #30248 observations that are duplicated

readmission_data$duplicate <- c()
readmission_data$duplicate <-ifelse(duplicated(readmission_data$patient_nbr,
                                               incomparables = FALSE),1,0)

names(readmission_data)

sum(readmission_data$duplicate)


distinct <- readmission_data %>%
  filter(duplicate == 1) %>%
  select(patient_nbr,duplicate) %>%
  arrange(desc(patient_nbr)) %>%
  distinct(patient_nbr)

nrow(distinct) #number of patients who visited the hospital more than once


names(readmission_data)

unique(readmission_data$diag1_mod) #unique primary diagnoses
unique(readmission_data$diag2_mod) #unique secondary diagnoses
unique(readmission_data$diag3_mod) #unique tertiary diagnoses

summary(readmission_data)
summary(readmission_data$diag1_mod)
class(readmission_data$diag1_mod)


class(readmission_data$diag1_mod)
#readmission_data$diag2_mod<-as.character(readmission_data$diag2_mod) 
readmission_data$diag1_name <- c()
readmission_data$diag1_name <- ifelse(as.character(readmission_data$diag1_mod) >=0 & as.character(readmission_data$diag1_mod) <= 139, "infect/para", 
                                      ifelse(as.character(readmission_data$diag1_mod) >= 140 & as.character(readmission_data$diag1_mod) <= 239, "neoplasms", 
                                             ifelse(as.character(readmission_data$diag1_mod) >= 240 & as.character(readmission_data$diag1_mod) <= 279, "endocrine, nut & meta, immunity",
                                                    ifelse(as.character(readmission_data$diag1_mod) >= 280 & as.character(readmission_data$diag1_mod) <= 289, "blood & blood-forming organs",
                                                           ifelse(as.character(readmission_data$diag1_mod) >= 290 & as.character(readmission_data$diag1_mod) <= 319, "mental disorders", 
                                                                  ifelse(as.character(readmission_data$diag1_mod) >= 320 & as.character(readmission_data$diag1_mod) <= 359, "nervous system", 
                                                                         ifelse(as.character(readmission_data$diag1_mod) >= 360 & as.character(readmission_data$diag1_mod) <= 389, "sense organs", 
                                                                                ifelse(as.character(readmission_data$diag1_mod) >= 390 & as.character(readmission_data$diag1_mod) <= 459, "circulatory system", 
                                                                                       ifelse(as.character(readmission_data$diag1_mod) >= 460 & as.character(readmission_data$diag1_mod) <= 519, "respiratory system", 
                                                                                              ifelse(as.character(readmission_data$diag1_mod) >= 520 & as.character(readmission_data$diag1_mod) <= 579, "digestive system", 
                                                                                                     ifelse(as.character(readmission_data$diag1_mod) >= 580 & as.character(readmission_data$diag1_mod) <= 629, "genitourinary system", 
                                                                                                            ifelse(as.character(readmission_data$diag1_mod) >= 630 & as.character(readmission_data$diag1_mod) <= 679, "pregnancy, childbirth, & puerperium",
                                                                                                                   ifelse(as.character(readmission_data$diag1_mod) >= 680 & as.character(readmission_data$diag1_mod) <= 709, "skin & subcutaneous tissue",
                                                                                                                          ifelse(as.character(readmission_data$diag1_mod) >= 710 & as.character(readmission_data$diag1_mod) <= 739, "musculoskeletal system & connective tissue",
                                                                                                                                 ifelse(as.character(readmission_data$diag1_mod) >= 740 & as.character(readmission_data$diag1_mod) <= 759, "congenital anomalies",
                                                                                                                                        ifelse(as.character(readmission_data$diag1_mod) >= 760 & as.character(readmission_data$diag1_mod) <= 779, "perinatal period",
                                                                                                                                               ifelse(as.character(readmission_data$diag1_mod) >= 780 & as.character(readmission_data$diag1_mod) <= 799, "symptoms, signs, & ill-defined conditions",
                                                                                                                                                      ifelse(as.character(readmission_data$diag1_mod) >= 800 & as.character(readmission_data$diag1_mod) <= 999, "injury and poisoning",
                                                                                                                                                             ifelse(as.character(readmission_data$diag1_mod) == "V45", "external causes & supplemental",  "Other")))))))))))))))))))

readmission_data$diag1_name <-as.factor(readmission_data$diag1_name)

summary(readmission_data$diag1_name)
summary(readmission_data$diag1_mod)
table(readmission_data$diag1_name)

print(levels(readmission_data$diag1_name))
summary(readmission_data$diag1_name)
summary(readmission_data)

summary(readmission_data)




#readmission_data$diag2_mod<-as.character(readmission_data$diag2_mod) 
readmission_data$diag2_name <- c()
readmission_data$diag2_name <- ifelse(as.character(readmission_data$diag2_mod) >=0 & as.character(readmission_data$diag2_mod) <= 139, "infect/para", 
                                      ifelse(as.character(readmission_data$diag2_mod) >= 140 & as.character(readmission_data$diag2_mod) <= 239, "neoplasms", 
                                             ifelse(as.character(readmission_data$diag2_mod) >= 240 & as.character(readmission_data$diag2_mod) <= 279, "endocrine, nut & meta, immunity",
                                                    ifelse(as.character(readmission_data$diag2_mod) >= 280 & as.character(readmission_data$diag2_mod) <= 289, "blood & blood-forming organs",
                                                           ifelse(as.character(readmission_data$diag2_mod) >= 290 & as.character(readmission_data$diag2_mod) <= 319, "mental disorders", 
                                                                  ifelse(as.character(readmission_data$diag2_mod) >= 320 & as.character(readmission_data$diag2_mod) <= 359, "nervous system", 
                                                                         ifelse(as.character(readmission_data$diag2_mod) >= 360 & as.character(readmission_data$diag2_mod) <= 389, "sense organs", 
                                                                                ifelse(as.character(readmission_data$diag2_mod) >= 390 & as.character(readmission_data$diag2_mod) <= 459, "circulatory system", 
                                                                                       ifelse(as.character(readmission_data$diag2_mod) >= 460 & as.character(readmission_data$diag2_mod) <= 519, "respiratory system", 
                                                                                              ifelse(as.character(readmission_data$diag2_mod) >= 520 & as.character(readmission_data$diag2_mod) <= 579, "digestive system", 
                                                                                                     ifelse(as.character(readmission_data$diag2_mod) >= 580 & as.character(readmission_data$diag2_mod) <= 629, "genitourinary system", 
                                                                                                            ifelse(as.character(readmission_data$diag2_mod) >= 630 & as.character(readmission_data$diag2_mod) <= 679, "pregnancy, childbirth, & puerperium",
                                                                                                                   ifelse(as.character(readmission_data$diag2_mod) >= 680 & as.character(readmission_data$diag2_mod) <= 709, "skin & subcutaneous tissue",
                                                                                                                          ifelse(as.character(readmission_data$diag2_mod) >= 710 & as.character(readmission_data$diag2_mod) <= 739, "musculoskeletal system & connective tissue",
                                                                                                                                 ifelse(as.character(readmission_data$diag2_mod) >= 740 & as.character(readmission_data$diag2_mod) <= 759, "congenital anomalies",
                                                                                                                                        ifelse(as.character(readmission_data$diag2_mod) >= 760 & as.character(readmission_data$diag2_mod) <= 779, "perinatal period",
                                                                                                                                               ifelse(as.character(readmission_data$diag2_mod) >= 780 & as.character(readmission_data$diag2_mod) <= 799, "symptoms, signs, & ill-defined conditions",
                                                                                                                                                      ifelse(as.character(readmission_data$diag2_mod) >= 800 & as.character(readmission_data$diag2_mod) <= 999, "injury and poisoning",
                                                                                                                                                             ifelse(as.character(readmission_data$diag2_mod) == "V45", "external causes & supplemental", "Other")))))))))))))))))))
readmission_data$diag2_name <-as.factor(readmission_data$diag2_name) 
summary(readmission_data$diag2_name)
summary(readmission_data$diag2_mod)


readmission_data$diag3_name <- c()
readmission_data$diag3_mod <- revalue(readmission_data$diag3_mod, c("?"="Other"))
readmission_data$diag3_name <- ifelse(as.character(readmission_data$diag3_mod) >=0 & as.character(readmission_data$diag3_mod) <= 139, "infect/para", 
                                      ifelse(as.character(readmission_data$diag3_mod) >= 140 & as.character(readmission_data$diag3_mod) <= 239, "neoplasms", 
                                             ifelse(as.character(readmission_data$diag3_mod) >= 240 & as.character(readmission_data$diag3_mod) <= 279, "endocrine, nut & meta, immunity",
                                                    ifelse(as.character(readmission_data$diag3_mod) >= 280 & as.character(readmission_data$diag3_mod) <= 289, "blood & blood-forming organs",
                                                           ifelse(as.character(readmission_data$diag3_mod) >= 290 & as.character(readmission_data$diag3_mod) <= 319, "mental disorders", 
                                                                  ifelse(as.character(readmission_data$diag3_mod) >= 320 & as.character(readmission_data$diag3_mod) <= 359, "nervous system", 
                                                                         ifelse(as.character(readmission_data$diag3_mod) >= 360 & as.character(readmission_data$diag3_mod) <= 389, "sense organs", 
                                                                                ifelse(as.character(readmission_data$diag3_mod) >= 390 & as.character(readmission_data$diag3_mod) <= 459, "circulatory system", 
                                                                                       ifelse(as.character(readmission_data$diag3_mod) >= 460 & as.character(readmission_data$diag3_mod) <= 519, "respiratory system", 
                                                                                              ifelse(as.character(readmission_data$diag3_mod) >= 520 & as.character(readmission_data$diag3_mod) <= 579, "digestive system", 
                                                                                                     ifelse(as.character(readmission_data$diag3_mod) >= 580 & as.character(readmission_data$diag3_mod) <= 629, "genitourinary system", 
                                                                                                            ifelse(as.character(readmission_data$diag3_mod) >= 630 & as.character(readmission_data$diag3_mod) <= 679, "pregnancy, childbirth, & puerperium",
                                                                                                                   ifelse(as.character(readmission_data$diag3_mod) >= 680 & as.character(readmission_data$diag3_mod) <= 709, "skin & subcutaneous tissue",
                                                                                                                          ifelse(as.character(readmission_data$diag3_mod) >= 710 & as.character(readmission_data$diag3_mod) <= 739, "musculoskeletal system & connective tissue",
                                                                                                                                 ifelse(as.character(readmission_data$diag3_mod) >= 740 & as.character(readmission_data$diag3_mod) <= 759, "congenital anomalies",
                                                                                                                                        ifelse(as.character(readmission_data$diag3_mod) >= 760 & as.character(readmission_data$diag3_mod) <= 779, "perinatal period",
                                                                                                                                               ifelse(as.character(readmission_data$diag3_mod) >= 780 & as.character(readmission_data$diag3_mod) <= 799, "symptoms, signs, & ill-defined conditions",
                                                                                                                                                      ifelse(as.character(readmission_data$diag3_mod) >= 800 & as.character(readmission_data$diag3_mod) <= 999, "injury and poisoning",
                                                                                                                                                             ifelse(as.character(readmission_data$diag3_mod) == "V45", "external causes & supplemental", "Other" )))))))))))))))))))
readmission_data$diag3_name <-as.factor(readmission_data$diag3_name)
summary(readmission_data$diag3_name)
summary(readmission_data$diag3_mod)
summary(readmission_data)


###cleaning RACE, reference category is OTHER
levels(readmission_data$race)
NA_race <- which(readmission_data$race == "?") #identifying the sissings
readmission_data <- readmission_data[-NA_race,] #removing the missings
table(readmission_data$race)
readmission_data$race <- droplevels(readmission_data$race)
table(readmission_data$race)
readmission_data$race <- revalue(readmission_data$race, c("AfricanAmerican"="African-American", #changing level names
                                                          "Asian"="Asian", "Caucasian"="Caucasian", "Hispanic"="Hispanic", 
                                                          "Other"="Other"))
readmission_data$race <- relevel(readmission_data$race, "Other")  #changing reference category to Other

summary(readmission_data)
table(readmission_data$race)

### cleaning GENDER, reference category is MALE
levels(readmission_data$gender)
summary(readmission_data$gender)
NA_gender <- which(readmission_data$gender == "Unknown/Invalid")
readmission_data <- readmission_data[-NA_gender,]
summary(readmission_data$gender)
readmission_data$gender <- droplevels(readmission_data$gender)
## releveling gender
readmission_data$gender <- relevel(readmission_data$gender, "Male","Female")  #reference category is MALE
table(readmission_data$gender)

#releveling max_glu_serum and creating recode_max_glu_serum #reference category for max_glu_serum is NONE, ref for recode is Not Tested
table(readmission_data$max_glu_serum)
print(levels(readmission_data$max_glu_serum))
readmission_data$max_glu_serum <- factor(readmission_data$max_glu_serum,levels(readmission_data$max_glu_serum)[c(3,4,1,2)]) #releveling 
table(readmission_data$max_glu_serum)
readmission_data$recode_max_glu_serum <- c()
readmission_data$recode_max_glu_serum <- revalue(readmission_data$max_glu_serum, c(">200"="Elevated",">300"="Elevated","None"="Not Tested", "Norm"="Normal")) #collapsed >7 and >8 into "Elevated" category
table(readmission_data$recode_max_glu_serum)

### Cleaning and releveling A1Cresult and created a recoded A1Cresult and releveling recode_A1Cresult
class(readmission_data$A1Cresult)
table(readmission_data$A1Cresult)
readmission_data$recode_A1Cresult <- c()
readmission_data$recode_A1Cresult <- revalue(readmission_data$A1Cresult, c(">7"="Elevated",">8"="Elevated","None"="Not Tested", "Norm"="Normal")) #collapsed >7 and >8 into "Elevated" category
table(readmission_data$recode_A1Cresult)
print(levels(readmission_data$A1Cresult))
readmission_data$A1Cresult <- factor(readmission_data$A1Cresult,levels(readmission_data$A1Cresult)[c(3,4,1,2)]) #releveling 
print(levels(readmission_data$recode_A1Cresult))
readmission_data$recode_A1Cresult <- factor(readmission_data$recode_A1Cresult,levels(readmission_data$recode_A1Cresult)[c(2,3,1)]) #releveling
table(readmission_data$recode_A1Cresult)

### creating recode_metformin
names(readmission_data)
table(readmission_data$metformin)
levels(readmission_data$metformin) 
readmission_data$recode_metformin <- c()
readmission_data$recode_metformin <- revalue(readmission_data$metformin, c("Down"="Yes", "No"="No",
                                                                           "Steady"="Yes", "Up"="Yes"))
readmission_data$recode_metformin <- relevel(readmission_data$recode_metformin, "No")

###creating recode_glimepiride
readmission_data$recode_glimepiride <- c()
readmission_data$recode_glimepiride <- revalue(readmission_data$glimepiride, c("Down"="Yes", "No"="No",
                                                                               "Steady"="Yes", "Up"="Yes"))
readmission_data$recode_glimepiride <- relevel(readmission_data$recode_glimepiride, "No")
table(readmission_data$recode_glimepiride)

###creating recode_glipizide
readmission_data$recode_glipizide <- c()
readmission_data$recode_glipizide <- revalue(readmission_data$glipizide, c("Down"="Yes", "No"="No",
                                                                           "Steady"="Yes", "Up"="Yes"))
readmission_data$recode_glipizide <- relevel(readmission_data$recode_glipizide, "No")
table(readmission_data$recode_glipizide)

###creating recode_glyburide
readmission_data$recode_glyburide <- c()
readmission_data$recode_glyburide <- revalue(readmission_data$glyburide, c("Down"="Yes", "No"="No",
                                                                           "Steady"="Yes", "Up"="Yes"))
readmission_data$recode_glyburide <- relevel(readmission_data$recode_glyburide, "No")
table(readmission_data$recode_glyburide)

###creating recode_pioglitazone
readmission_data$recode_pioglitazone <- c()
readmission_data$recode_pioglitazone <- revalue(readmission_data$pioglitazone, c("Down"="Yes", "No"="No",
                                                                                 "Steady"="Yes", "Up"="Yes"))
readmission_data$recode_pioglitazone <- relevel(readmission_data$recode_pioglitazone, "No")
table(readmission_data$recode_pioglitazone)

###creating recode_rosiglitazone
readmission_data$recode_rosiglitazone <- c()
readmission_data$recode_rosiglitazone <- revalue(readmission_data$rosiglitazone, c("Down"="Yes", "No"="No",
                                                                                   "Steady"="Yes", "Up"="Yes"))
readmission_data$recode_rosiglitazone <- relevel(readmission_data$recode_rosiglitazone, "No")
table(readmission_data$recode_rosiglitazone)

###relevling insulin
readmission_data$insulin <- relevel(readmission_data$insulin, "No","Down","Steady","Up")
table(readmission_data$insulin)

###releveling change
table(readmission_data$change)
readmission_data$change <- revalue(readmission_data$change, c("Ch"="Yes", "No"="No"))
readmission_data$change <- relevel(readmission_data$change, "No")

#releveling disch_disp_modified
table(readmission_data$disch_disp_modified)
readmission_data$disch_disp_modified <- relevel(readmission_data$disch_disp_modified, "Other")

#releveling adm_src_mod
table(readmission_data$adm_src_mod)
readmission_data$adm_src_mod <- relevel(readmission_data$adm_src_mod, "Other")

#releveling adm_typ_mod
table(readmission_data$adm_typ_mod)
readmission_data$adm_typ_mod <- relevel(readmission_data$adm_typ_mod, "Other")

#releveling recode_readmitted No = not readmitted w/in 30 days, Yes = readmitted w/in 30 days
table(readmission_data$recode_readmitted)
readmission_data$recode_readmitted <- revalue(readmission_data$recode_readmitted, c("1"="Yes", "0"="No"))
readmission_data$recode_readmitted <- relevel(readmission_data$recode_readmitted, "No")

names(readmission_data)

summary(readmission_data$diag1_mod)

table(readmission_data$diag1_mod)

summary(readmission_data$recode_readmitted)

readmission_data2 <- readmission_data[,-c(1,2,15:20,28:31,33,37:38)] #taking out encounter_id, patient_nbr, "metformin","glimepiride",
#"glipizide", "glyburide","pioglitazone","rosiglitazone""diag1_mod"
#"diag2_mod","diag3_mod","readmitted","duplicate",recode_A1Cresult, and recode_max_glu_serum 
#(WITH ORIGINAL A1C and GLU variables) 

readmission_data3 <- readmission_data[,-c(1,2,13:20,28:31,33)]       #taking out encounter_id, patient_nbr, "metformin","glimepiride", A1Cresult, max_glu_serum
#"glipizide", "glyburide","pioglitazone","rosiglitazone""diag1_mod"
#"diag2_mod","diag3_mod","readmitted","duplicate", (WITH RECODED A1C and GLU VARIABLES)
names(readmission_data)
names(readmission_data2)
names(readmission_data3)
```

## Exploratory Data Analysis

Figure 1: Frequency of Time Spent in the Hospital by Readmittance Status:
```{r}
#use this fig for proposal time in hospital and readmission
ggplot(readmission_data, aes(x = time_in_hospital, fill = recode_readmitted)) +
  geom_density(position = "stack") +
  xlim(0, 16) 
```

Figure 2: Frequency of Short-term Readmission by Age Group:

```{r}
age <- as.data.frame(table(readmission_data$recode_readmitted, readmission_data$age_mod))
names(age) <- c("Readmitted","Age_Group", "Frequency")
##age and readmission
ggplot(age, aes(fill = Readmitted, y = Frequency, x = Age_Group)) + 
  geom_bar(aes(fill = Readmitted), position="dodge", stat="identity")
```

## One-Hot Encoding

```{r echo=F, results='hide'}
## ONE-HOT ENCODING CATEGORICAL VARIABLES:
readmission_data <- fastDummies::dummy_cols(readmission_data)

readmission_data2 <- fastDummies::dummy_cols(readmission_data2)


readmission_data3 <- fastDummies::dummy_cols(readmission_data3)

readmission_data2 <- readmission_data2[,-c(1,2,11:19,21:29,69,70)] #dropping non-dummy categorical features from readmission_data2 dataset (numbers are likely different for datasets one and three)

names(readmission_data2) #the target variable (recode_readmitted) is now col. #9 in the dataset with categorical vars removed. 

```
## Feature Selection via the LASSO and Manual Backwards Selection

```{r echo=F, results='hide'}
#### MODEL SELECTION ####
###DO DATA SPLITS FIRST
N <- length(readmission_data2$recode_readmitted)
N
set.seed(10) 
index.train <- sample(N, (N/2))
data.train <- readmission_data2[index.train,] # Set the N/2 randomly chosen subjects as a training data
data.test <- readmission_data2[-index.train,] # The remaining subjects will be reserved for testing purposes.

####LASSO####
names(data.train)
X <- model.matrix(recode_readmitted~., data.train)[,-1] #this stays at 1
dim(X)
colnames(X)
names(data.train)
Y <- data.train[,9]  #col 20 in data2, 18 in data3 (whatever column is recode_readmitted in a given dataset)

set.seed(10)  
##### with type.measure = deviance ####  
fit1.cv <- cv.glmnet(X,Y, alpha=1, family="binomial", nfolds = 10, type.measure = "deviance")
```

## Plotting Values of the Tuning Parameter Lambda with Deviance:
```{r}
plot(fit1.cv)
```

```{r echo=F, results='hide'}
names(fit1.cv)
fit1.cv$name

#using lambda.1se:
coef.1se <- coef(fit1.cv, s= "lambda.1se")
coef.1se <- coef.1se[which(coef.1se !=0),]
coef.1se
rownames(as.matrix(coef.1se))

#using lambda.min:
coef.min <-coef(fit1.cv, s="lambda.min") 
coef.min <- coef.min[which(coef.min !=0), ]

as.matrix(coef.min)
rownames(as.matrix(coef.min))

#### with type.measure = AUC ####
fit2.cv <- cv.glmnet(X,Y, alpha=1, family="binomial", nfolds = 10, type.measure = "auc")
```

## Plotting Values of the Tuning Parameter Lambda with AUC:
```{r}
plot(fit2.cv)
```

```{r echo=F, results='hide'}
names(fit2.cv)
fit2.cv$name

#using lambda.1se:
coef.1se <- coef(fit2.cv, s= "lambda.1se")
coef.1se <- coef.1se[which(coef.1se !=0),]
coef.1se
rownames(as.matrix(coef.1se))

#using lambda.min:
coef.min <-coef(fit2.cv, s="lambda.min") 
coef.min <- coef.min[which(coef.min !=0), ]

as.matrix(coef.min)
rownames(as.matrix(coef.min))

##### with type.measure = class ####
fit3.cv <- cv.glmnet(X,Y, alpha=1, family="binomial", nfolds = 10, type.measure = "class") #misclassification error
```
## Plotting Values of the Tuning Parameter Lambda with Misclassification Error:
```{r}
plot(fit3.cv)
```

```{r echo=F, results='hide'}
names(fit3.cv)
fit3.cv$name

#using lambda.1se:
coef.1se <- coef(fit3.cv, s= "lambda.1se")
coef.1se <- coef.1se[which(coef.1se !=0),]
coef.1se
rownames(as.matrix(coef.1se))

#using lambda.min:
coef.min <-coef(fit3.cv, s="lambda.min") 
coef.min <- coef.min[which(coef.min !=0), ]

as.matrix(coef.min)
rownames(as.matrix(coef.min))

#Final AUC Model (Use AUC + lambda.1st) - manageable # of betas
names(readmission_data2)
beta.1se <- rownames(as.matrix(coef.1se)) 

fit1.train <- glm(recode_readmitted ~ time_in_hospital + num_procedures + num_medications + number_emergency + number_inpatient + number_diagnoses + 
                    `max_glu_serum_>200` + A1Cresult_None + insulin_No + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                    `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Emergency Room` + `adm_src_mod_Transfer from Home Health` + adm_typ_mod_Emergency + 
                    `age_mod_0-19` + `age_mod_20-59`+ `age_mod_60-79` + `diag1_name_endocrine, nut & meta, immunity` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                    `diag1_name_symptoms, signs, & ill-defined conditions` + diag2_name_Other + `diag2_name_respiratory system` + `diag2_name_skin & subcutaneous tissue` + 
                    `diag3_name_endocrine, nut & meta, immunity` + `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.train, family=binomial(logit)) 
summary(fit1.train)
Anova(fit1.train)
fit1.roc <-roc(data.train$recode_readmitted, fit1.train$fitted.values, plot=T, col="blue")
fit1.roc$auc #Area under the curve: 0.6521

#Manual Backwards Selection:

#1) dropping insulin_No
fit2.train <- glm(recode_readmitted ~ time_in_hospital + num_procedures + num_medications + number_emergency + number_inpatient + number_diagnoses + 
                    `max_glu_serum_>200` + A1Cresult_None + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                    `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Emergency Room` + `adm_src_mod_Transfer from Home Health` + adm_typ_mod_Emergency + 
                    `age_mod_0-19` + `age_mod_20-59`+ `age_mod_60-79` + `diag1_name_endocrine, nut & meta, immunity` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                    `diag1_name_symptoms, signs, & ill-defined conditions` + diag2_name_Other + `diag2_name_respiratory system` + `diag2_name_skin & subcutaneous tissue` + 
                    `diag3_name_endocrine, nut & meta, immunity` + `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.train, family=binomial(logit)) 
summary(fit2.train)
Anova(fit2.train)
fit2.roc <-roc(data.train$recode_readmitted, fit2.train$fitted.values, plot=T, col="blue")
fit2.roc$auc #Area under the curve: 0.6521

#2) dropping admin_src_mod_EmergencyRoom
fit3.train <- glm(recode_readmitted ~ time_in_hospital + num_procedures + num_medications + number_emergency + number_inpatient + number_diagnoses + 
                    `max_glu_serum_>200` + A1Cresult_None + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                    `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Transfer from Home Health` + adm_typ_mod_Emergency + 
                    `age_mod_0-19` + `age_mod_20-59`+ `age_mod_60-79` + `diag1_name_endocrine, nut & meta, immunity` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                    `diag1_name_symptoms, signs, & ill-defined conditions` + diag2_name_Other + `diag2_name_respiratory system` + `diag2_name_skin & subcutaneous tissue` + 
                    `diag3_name_endocrine, nut & meta, immunity` + `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.train, family=binomial(logit)) 
summary(fit3.train)
Anova(fit3.train)
fit3.roc <-roc(data.train$recode_readmitted, fit3.train$fitted.values, plot=T, col="blue")
fit3.roc$auc #Area under the curve: 0.652

#3) dropping `diag3_name_endocrine, nut & meta, immunity`
fit4.train <- glm(recode_readmitted ~ time_in_hospital + num_procedures + num_medications + number_emergency + number_inpatient + number_diagnoses + 
                    `max_glu_serum_>200` + A1Cresult_None + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                    `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Transfer from Home Health` + adm_typ_mod_Emergency + 
                    `age_mod_0-19` + `age_mod_20-59`+ `age_mod_60-79` + `diag1_name_endocrine, nut & meta, immunity` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                    `diag1_name_symptoms, signs, & ill-defined conditions` + diag2_name_Other + `diag2_name_respiratory system` + `diag2_name_skin & subcutaneous tissue` + 
                    `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.train, family=binomial(logit)) 
summary(fit4.train)
Anova(fit4.train)
fit4.roc <-roc(data.train$recode_readmitted, fit4.train$fitted.values, plot=T, col="blue")
fit4.roc$auc #Area under the curve: 0.6519

#4) dropping time_in_hospital
fit5.train <- glm(recode_readmitted ~ num_procedures + num_medications + number_emergency + number_inpatient + number_diagnoses + 
                    `max_glu_serum_>200` + A1Cresult_None + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                    `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Transfer from Home Health` + adm_typ_mod_Emergency + 
                    `age_mod_0-19` + `age_mod_20-59`+ `age_mod_60-79` + `diag1_name_endocrine, nut & meta, immunity` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                    `diag1_name_symptoms, signs, & ill-defined conditions` + diag2_name_Other + `diag2_name_respiratory system` + `diag2_name_skin & subcutaneous tissue` + 
                    `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.train, family=binomial(logit)) 
summary(fit5.train)
Anova(fit5.train)
fit5.roc <-roc(data.train$recode_readmitted, fit5.train$fitted.values, plot=T, col="blue")
fit5.roc$auc #Area under the curve: 0.6517

#5) dropping age_mod_20_59
fit6.train <- glm(recode_readmitted ~ num_procedures + num_medications + number_emergency + number_inpatient + number_diagnoses + 
                    `max_glu_serum_>200` + A1Cresult_None + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                    `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Transfer from Home Health` + adm_typ_mod_Emergency + 
                    `age_mod_0-19` + `age_mod_60-79` + `diag1_name_endocrine, nut & meta, immunity` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                    `diag1_name_symptoms, signs, & ill-defined conditions` + diag2_name_Other + `diag2_name_respiratory system` + `diag2_name_skin & subcutaneous tissue` + 
                    `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.train, family=binomial(logit)) 
summary(fit6.train)
Anova(fit6.train)
fit6.roc <-roc(data.train$recode_readmitted, fit6.train$fitted.values, plot=T, col="blue")
fit6.roc$auc #Area under the curve: 0.6515

#6) dropping diag1_endocrine, nut & meta, immunity
fit7.train <- glm(recode_readmitted ~ num_procedures + num_medications + number_emergency + number_inpatient + number_diagnoses + 
                    `max_glu_serum_>200` + A1Cresult_None + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                    `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Transfer from Home Health` + adm_typ_mod_Emergency + 
                    `age_mod_0-19` + `age_mod_60-79` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                    `diag1_name_symptoms, signs, & ill-defined conditions` + diag2_name_Other + `diag2_name_respiratory system` + `diag2_name_skin & subcutaneous tissue` + 
                    `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.train, family=binomial(logit)) 
summary(fit7.train)
Anova(fit7.train)
fit7.roc <-roc(data.train$recode_readmitted, fit7.train$fitted.values, plot=T, col="blue")
fit7.roc$auc #Area under the curve: 0.6515

#7) dropping diag2_name_Other
fit8.train <- glm(recode_readmitted ~ num_procedures + num_medications + number_emergency + number_inpatient + number_diagnoses + 
                    `max_glu_serum_>200` + A1Cresult_None + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                    `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Transfer from Home Health` + adm_typ_mod_Emergency + 
                    `age_mod_0-19` + `age_mod_60-79` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                    `diag1_name_symptoms, signs, & ill-defined conditions` + `diag2_name_respiratory system` + `diag2_name_skin & subcutaneous tissue` + 
                    `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.train, family=binomial(logit)) 
summary(fit8.train)
Anova(fit8.train)
fit8.roc <-roc(data.train$recode_readmitted, fit8.train$fitted.values, plot=T, col="blue")
fit8.roc$auc #Area under the curve: 0.6514

#8) dropping `diag2_name_skin & subcutaneous tissue`
fit9.train <- glm(recode_readmitted ~ num_procedures + num_medications + number_emergency + number_inpatient + number_diagnoses + 
                    `max_glu_serum_>200` + A1Cresult_None + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                    `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Transfer from Home Health` + adm_typ_mod_Emergency + 
                    `age_mod_0-19` + `age_mod_60-79` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                    `diag1_name_symptoms, signs, & ill-defined conditions` + `diag2_name_respiratory system` + 
                    `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.train, family=binomial(logit)) 
summary(fit9.train)
Anova(fit9.train)
fit9.roc <-roc(data.train$recode_readmitted, fit9.train$fitted.values, plot=T, col="blue")
fit9.roc$auc #Area under the curve: 0.6512

#9) dropping number_emergency 
fit10.train <- glm(recode_readmitted ~ num_procedures + num_medications + number_inpatient + number_diagnoses + 
                    `max_glu_serum_>200` + A1Cresult_None + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                    `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Transfer from Home Health` + adm_typ_mod_Emergency + 
                    `age_mod_0-19` + `age_mod_60-79` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                    `diag1_name_symptoms, signs, & ill-defined conditions` + `diag2_name_respiratory system` + 
                    `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.train, family=binomial(logit)) 
summary(fit10.train)
Anova(fit10.train)
fit10.roc <-roc(data.train$recode_readmitted, fit10.train$fitted.values, plot=T, col="blue")
fit10.roc$auc #Area under the curve:  0.6508

#10) drop A1Cresult_None
fit11.train <- glm(recode_readmitted ~ num_procedures + num_medications + number_inpatient + number_diagnoses + 
                     `max_glu_serum_>200` + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                     `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Transfer from Home Health` + adm_typ_mod_Emergency + 
                     `age_mod_0-19` + `age_mod_60-79` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                     `diag1_name_symptoms, signs, & ill-defined conditions` + `diag2_name_respiratory system` + 
                     `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.train, family=binomial(logit)) 
summary(fit11.train)
Anova(fit11.train)
fit11.roc <-roc(data.train$recode_readmitted, fit11.train$fitted.values, plot=T, col="blue")
fit11.roc$auc #Area under the curve: 0.6507

#11) drop adm_typ_mod_Emergency ***fit12 = FINAL MODEL***
fit12.train <- glm(recode_readmitted ~ num_procedures + num_medications + number_inpatient + number_diagnoses + 
                     `max_glu_serum_>200` + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                     `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Transfer from Home Health` + 
                     `age_mod_0-19` + `age_mod_60-79` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                     `diag1_name_symptoms, signs, & ill-defined conditions` + `diag2_name_respiratory system` + 
                     `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.train, family=binomial(logit)) 
summary(fit12.train)
Anova(fit12.train)
```
## Plotting the ROC Curve and Estimating the Area Under the Curve of the Final Model
```{r}
fit12.roc <-roc(data.train$recode_readmitted, fit12.train$fitted.values, plot=T, col="blue")
fit12.roc$auc #Area under the curve: 0.6501
```

## Building a classifier and assessing model performance in the test set

```{r echo=F, results='hide'}
#### CLASSIFICATION ####  

#DETERMING THE THRESHOLD:
### An example: Suppose (a_{0,1}/a_{1,0})=1/2=.5, then 
#The threshold over the prob(Y=1|x) > .5/(1+.5)=.333 
threshold <- .5/(1+.5)
logit <- log(threshold/(1-threshold))
fit12.train.pred.33 <- rep("0", length(data.train$recode_readmitted)) # prediction step 1, 101762 people in the dataset, threshold is 2/3
fit12.train.pred.33[fit12.train$fitted > threshold] <- "1" # prediction step 2 to get a classifier, fitted value is computing a probability for each person
fit12.train.pred.33 <- as.factor(fit12.train.pred.33) #creating y hat
length(fit12.train.pred.33)
# c) Misclassification error= Mean(miss-classification)
length(fit12.train$fitted)
# We can get all three quantities through confusion matrix or directly find the 
# mis-classification errors

set.seed(10) # be able to reproduce the following result.

cm.33 <- table(fit12.train.pred.33,data.train$recode_readmitted) # confusion matrix: 
cm.33

sensitivity <- cm.33[2,2]/sum(data.train$recode_readmitted == "Yes")
sensitivity

specificity <- cm.33[1,1]/ sum(data.train$recode_readmitted == "No")
false.positive <- cm.33[2,1]/sum(data.train$recode_readmitted == "No")  # 5/1095
false.positive

### Mis-classification error (MCE): she labels it as training error because that's what we're doing
error.training <- (cm.33[1,2]+cm.33[2,1])/length(fit12.train.pred.33) # training error
error.training #0.1147228


plot(1-fit12.roc$specificities, fit12.roc$thresholds, col="green", pch=16,  
     xlab="False Positive",
     ylab="Threshold on prob")


#   e) Positive Prediction
#   f) Negative Prediction 

# Positive Prediction = P( Positive | Classified as Positive)
# Negative Prediction = P( Negative | Classified as Negative)

positive.pred <- cm.33[2, 2] / (cm.33[2, 1] + cm.33[2, 2])
positive.pred #0.3820598

negative.pred <- cm.33[1, 1] / (cm.33[1, 1] + cm.33[1, 2])
negative.pred #0.8913194 - correct 89% of the time when classifying a patient as not being readmitted within 30 days

### Finally we get the weighted mis-classification error
# MCE=(a10 sum(y != hat y|y=1) + a01 sum(y != hat y|y=0))/n

# Get the classes first
fit12.train.pred.bayes=rep("0", length(data.train$recode_readmitted))
fit12.train.pred.bayes[fit12.train$fitted > threshold]="1" #fitted value is a probability
MCE.bayes=(sum(2*(fit12.train.pred.bayes[data.train$recode_readmitted == "Yes"] != "1")) 
           + sum(fit12.train.pred.bayes[data.train$recode_readmitted == "No"] != "0"))/length(data.train$recode_readmitted)
MCE.bayes #0.2222088 On the whole, our model is wrong 22% of the time. 

fit12.test <- glm(recode_readmitted ~ num_procedures + num_medications + number_inpatient + number_diagnoses + 
                    `max_glu_serum_>200` + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
                    `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Transfer from Home Health` + 
                    `age_mod_0-19` + `age_mod_60-79` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
                    `diag1_name_symptoms, signs, & ill-defined conditions` + `diag2_name_respiratory system` + 
                    `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No, data.test, family=binomial(logit)) #SNF = skilled nursing facility

form <- recode_readmitted ~ num_procedures + num_medications + number_inpatient + number_diagnoses + 
  `max_glu_serum_>200` + insulin_Down + diabetesMed_No + disch_disp_modified_Other + `disch_disp_modified_Discharged to home` + 
  `disch_disp_modified_Discharged/Transferred to SNF` + `adm_src_mod_Transfer from Home Health` + 
  `age_mod_0-19` + `age_mod_60-79` + `diag1_name_respiratory system` + `diag1_name_skin & subcutaneous tissue` +
  `diag1_name_symptoms, signs, & ill-defined conditions` + `diag2_name_respiratory system` + 
  `diag3_name_genitourinary system` + diag3_name_Other + recode_glimepiride_No

summary(fit12.test) #FINAL MODEL
exp(coefficients(fit12.test))
fit12.roc <- roc(data.test$recode_readmitted, fit12.test$fitted.values, plot=T, col="blue") 
fit12.roc$auc #Area under the curve: 0.6453


##ASSESSING THE MODEL PERFORMANCE IN THE TEST DATA: 

#DETERMING THE THRESHOLD:
### An example: Suppose (a_{0,1}/a_{1,0})=1/2=.5, then 
#The threshold over the prob(Y=1|x) > .5/(1+.5)=.333 
threshold <- .5/(1+.5)
logit <- log(threshold/(1-threshold))
fit12.test.pred.33 <- rep("0", length(data.test$recode_readmitted)) # prediction step 1, 101762 people in the dataset, threshold is 2/3
fit12.test.pred.33[fit12.test$fitted > threshold] <- "1" # prediction step 2 to get a classifier, fitted value is computing a probability for each person
fit12.test.pred.33 <- as.factor(fit12.test.pred.33) #creating y hat
length(fit12.test.pred.33)
# c) Misclassification error= Mean(miss-classification)
length(fit12.test$fitted)
# We can get all three quantities through confusion matrix or directly find the 
# mis-classification errors

set.seed(10) # be able to reproduce the following result.

cm.33 <- table(fit12.test.pred.33,data.test$recode_readmitted) # confusion matrix: 
cm.33

sensitivity <- cm.33[2,2]/sum(data.test$recode_readmitted == "Yes")
sensitivity

specificity <- cm.33[1,1]/ sum(data.test$recode_readmitted == "No")
false.positive <- cm.33[2,1]/sum(data.test$recode_readmitted == "No")  # 5/1095
false.positive

### Mis-classification error (MCE): she labels it as training error because that's what we're doing
error.test <- (cm.33[1,2]+cm.33[2,1])/length(fit12.test.pred.33) # training error
error.test #0.1147228


plot(1-fit12.roc$specificities, fit12.roc$thresholds, col="green", pch=16,  
     xlab="False Positive",
     ylab="Threshold on prob")


#   e) Positive Prediction
#   f) Negative Prediction 

# Positive Prediction = P( Positive | Classified as Positive)
# Negative Prediction = P( Negative | Classified as Negative)

positive.pred <- cm.33[2, 2] / (cm.33[2, 1] + cm.33[2, 2])
positive.pred #0.3945578

negative.pred <- cm.33[1, 1] / (cm.33[1, 1] + cm.33[1, 2])
negative.pred #0.8908418 - correct 89% of the time when classifying a patient as not being readmitted within 30 days

### Finally we get the weighted mis-classification error
# MCE=(a10 sum(y != hat y|y=1) + a01 sum(y != hat y|y=0))/n

# Get the classes first
fit12.test.pred.bayes=rep("0", length(data.test$recode_readmitted))
fit12.test.pred.bayes[fit12.test$fitted > threshold]="1" #fitted value is a probability
MCE.bayes=(sum(2*(fit12.test.pred.bayes[data.test$recode_readmitted == "Yes"] != "1")) 
           + sum(fit12.test.pred.bayes[data.test$recode_readmitted == "No"] != "0"))/length(data.test$recode_readmitted)
MCE.bayes #0.2228923 

names(fit12.test)
```
##Model Accuracy

Our model is correct nearly 90% of the time when it classifies a patient as not being readmitted within 30 days. 

##Next steps:

- Explore stochastic gradient boosting in an effort to get model error rates even lower. 
